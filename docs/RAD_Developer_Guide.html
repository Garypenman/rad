<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RAD | Developer Guide</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background: #0f172a; color: #cbd5e1; }
    .rad-card { background: #1e293b; border: 1px solid #334155; border-radius: 1rem; margin-bottom: 2rem; }
    .code-block { background: #020617; border: 1px solid #1e293b; padding: 1.5rem; border-radius: 0.5rem; font-family: monospace; color: #a5b4fc; white-space: pre; overflow-x: auto; font-size: 0.9em; }
    .section-title { font-size: 1.875rem; font-weight: 800; color: #f8fafc; margin-bottom: 1.5rem; border-bottom: 2px solid #334155; padding-bottom: 0.5rem; margin-top: 3rem; }
    .diagram-node { background: #3b82f6; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: bold; text-align: center; display: inline-block; margin: 0.5rem; }
    .sub-header { font-size: 1.25rem; font-weight: 700; color: #e2e8f0; margin-bottom: 1rem; margin-top: 1.5rem; }
    .role-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; margin-bottom: 0.5rem;}
    .role-injector { background: #06b6d4; color: #083344; }
    .role-modifier { background: #ec4899; color: #500724; }
    .role-creator { background: #8b5cf6; color: #2e1065; }
    .text-highlight { color: #38bdf8; font-weight: bold; }
  </style>
</head>
<body class="p-4 sm:p-8 max-w-7xl mx-auto">

  <nav class="flex justify-between items-center mb-12">
    <div class="text-2xl font-bold text-white">RAD <span class="font-normal text-slate-400">| Developer Guide</span></div>
    <div class="space-x-4">
      <a href="index.html" class="text-slate-400 hover:text-white font-medium">Home</a>
      <a href="RAD_User_Guide.html" class="text-slate-400 hover:text-white font-medium">User Guide</a>
      <a href="./reference/" target="_blank" class="text-blue-400 font-semibold">Doxygen API</a>
    </div>
  </nav>

  <section>
    <h2 class="section-title">1. Architecture Overview</h2>
    <p class="mb-6 text-lg text-slate-300">
        RAD is designed around a <strong>Structure of Arrays (SoA)</strong> philosophy to maximize cache locality and allow efficient vectorization within the RDataFrame event loop.
    </p>

    <div class="bg-slate-900 p-8 rounded-xl border border-slate-700 text-center">
        <div class="flex gap-8 w-full justify-center">
            <div class="diagram-node bg-slate-600">RDFInterface</div>
            <p class="text-sm self-center text-slate-400 text-left w-64">Wraps ROOT::RDataFrame state.<br>Handles <code>Define</code>, <code>Filter</code>, <code>Snapshot</code>.</p>
        </div>
        <div class="diagram-arrow text-slate-500 text-2xl my-2">↓</div>
        <div class="flex gap-8 w-full justify-center">
            <div class="diagram-node bg-indigo-600">ConfigReaction</div>
            <p class="text-sm self-center text-slate-400 text-left w-64">Manages Data Types (<code>rec_</code>, <code>tru_</code>).<br>Triggers the Combinatorial Engine.</p>
        </div>
        <div class="diagram-arrow text-slate-500 text-2xl my-2">↓</div>
        <div class="flex gap-8 w-full justify-center">
            <div class="diagram-node bg-blue-600">KinematicsProcessor</div>
            <p class="text-sm self-center text-slate-400 text-left w-64"><strong>The Engine.</strong><br>Runs the physics loop over combinations.</p>
        </div>
        
        <div class="flex gap-4 mt-8 pt-8 border-t border-slate-700 w-full justify-center">
            <div class="p-3 border border-slate-600 rounded bg-slate-800">
                <span class="role-badge role-injector">Injector</span>
                <p class="text-xs text-slate-400">Data Normalization</p>
            </div>
            <div class="p-3 border border-slate-600 rounded bg-slate-800">
                <span class="role-badge role-creator">Creator</span>
                <p class="text-xs text-slate-400">Topology Definition</p>
            </div>
            <div class="p-3 border border-slate-600 rounded bg-slate-800">
                <span class="role-badge role-modifier">Modifier</span>
                <p class="text-xs text-slate-400">Calibration & Corrections</p>
            </div>
        </div>
    </div>
  </section>

  <section>
    <h2 class="section-title">2. Data Layout: The Reaction Map</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div>
            <p class="mb-4">
                To avoid deep copies of particle objects, RAD separates <strong>Topology</strong> (Indices) from <strong>Data</strong> (Momentum Arrays).
            </p>
            <ul class="list-disc pl-5 space-y-2 text-slate-400">
                <li><strong class="text-white">Input:</strong> Flat RVecs (<code class="text-orange-300">rec_px, rec_py...</code>) containing all tracks in the event.</li>
                <li><strong class="text-white">Map:</strong> <code class="text-orange-300">ReactionMap</code>. A matrix of indices pointing to the flat arrays. <br>Dimensions: <code class="text-sm">[N_Combinations][N_Particles]</code></li>
                <li><strong class="text-white">Output:</strong> <code class="text-orange-300">RVec&lt;RVec&lt;double&gt;&gt;</code>. Physics results for every combination.</li>
            </ul>
        </div>
        <div class="rad-card p-6">
            <div class="code-block text-sm">
// Visualization of ReactionMap 
// Scenario: 2 candidates for e- (indices 0, 2), 1 for e+ (index 5)

IndexMap = {
  // e-  e+
  {  0,  5 },  // Combination 1
  {  2,  5 }   // Combination 2
}
            </div>
        </div>
    </div>
  </section>

  <section>
    <h2 class="section-title">3. The Combinatorial Engine</h2>
    <div class="rad-card p-6">
        <p class="mb-4">
            The core algorithm resides in <code>Combinatorics.h</code>. It converts variable-length lists of candidates into a fixed set of unique combinations.
        </p>
        
        <h3 class="text-xl font-bold text-white mb-2">Algorithm Steps:</h3>
        <ol class="list-decimal pl-5 space-y-2 text-slate-400">
            <li><strong>Input:</strong> A list of candidate index lists. <br>
                Example: Ele candidates <code>{0, 2}</code>, Pos candidates <code>{1}</code>.</li>
            <li><strong>Cartesian Product:</strong> The engine iterates through an N-dimensional loop of all permutations.</li>
            <li><strong>Uniqueness Filter:</strong> 
                <span class="text-highlight">Crucial Step.</span> If a permutation uses the same track index for multiple roles (e.g., trying to use Track 1 as both an Electron and a Pion), it is discarded.
            </li>
            <li><strong>Output:</strong> The <code>ReactionMap</code> structure used by the processors.</li>
        </ol>
    </div>
  </section>

  <section>
    <h2 class="section-title">4. Pattern: Twin Topology (InitLinked)</h2>
    <p class="mb-4">
        The most powerful feature for performance is the ability to run multiple hypotheses (e.g., "Detected Neutron" vs "Missing Neutron") using a single combinatorial sort.
    </p>
    <div class="rad-card p-6 border-l-4 border-yellow-500">
        <h3 class="font-bold text-white mb-2">How it works:</h3>
        <ol class="list-decimal pl-5 space-y-2 text-slate-400">
            <li><strong>Master Processor:</strong> Calls <code class="text-blue-300">Init()</code>. Calculates the heavy <code class="text-orange-300">ReactionMap</code> (sorting all tracks, checking uniqueness).</li>
            <li><strong>Linked Processor:</strong> Calls <code class="text-blue-300">InitLinked(master)</code>. It <strong>adopts</strong> the indices from the master.</li>
            <li><strong>Divergence:</strong> The Linked processor can have different <code class="text-blue-300">ParticleCreator</code> definitions (e.g., defining the "Baryon" slot as a missing mass calculation instead of a track lookup).</li>
            <li><strong>Result:</strong> RDataFrame runs the sorting loop <strong>ONCE</strong>. Both processors run their physics kernels on the same set of indices, but produce different physics results.</li>
        </ol>
    </div>
  </section>

  <section>
    <h2 class="section-title">5. Deep Dive: Extending the Managers</h2>
    <p class="mb-6 text-lg text-slate-300">Detailed guide on extending the three pillars of the framework.</p>

    <div class="rad-card p-6 border-l-4 border-cyan-500">
        <h3 class="text-xl font-bold text-white mb-2"><span class="role-badge role-injector">Injector</span> ParticleInjector</h3>
        <p class="text-slate-300 mb-4">
            <strong>Role:</strong> The "Normalization Layer". Standardizes disparate input formats (HepMC, Podio, Flat Trees) into the framework's expected columnar format (<code>rec_px</code>, <code>rec_pid</code>, etc.).
        </p>
        <h4 class="font-bold text-cyan-400 mb-2">How to Extend (New Data Format):</h4>
        <div class="code-block">
// Inside your custom Reaction class (e.g. MyExptReaction.h)
void Setup() {
  ParticleInjector injector(this);
  
  // 1. Define standard suffixes RAD expects
  injector.DefineParticleInfo({"px", "py", "pz", "m", "pid"});
  
  // 2. Map your raw branches to these suffixes
  // "rec_" becomes the prefix. "Track_Px" maps to "px", etc.
  injector.AddSource("rec_", {"Track_Px", "Track_Py", "Track_Pz", "Track_M", "Track_PID"});
  
  // 3. Generate the columns
  injector.CreateUnifiedVectors();
}
        </div>
    </div>

    <div class="rad-card p-6 border-l-4 border-purple-500">
        <h3 class="text-xl font-bold text-white mb-2"><span class="role-badge role-creator">Creator</span> ParticleCreator</h3>
        <p class="text-slate-300 mb-4">
            <strong>Role:</strong> The "Architect". Manages the definition of particles. It does not store data itself but calculates the <strong>Indices</strong> that point to the data. It handles the logic for creating composite particles (Sum/Diff).
        </p>
        <h4 class="font-bold text-purple-400 mb-2">How to Extend (New Creation Algorithm):</h4>
        <p class="text-sm text-slate-400 mb-2">To add a new creation method (e.g., "Create by Decay"), define a function with the <code>ParticleCreatorFunc_t</code> signature.</p>
        <div class="code-block">
// 1. Define the Calculation Logic (The Kernel)
// indices[0] = Mother, indices[1] = Daughter (passed via dependency list)
void MyDecayCreator(const Indice_t pos, const RVecIndices& indices, 
                    RVecD& px, RVecD& py, RVecD& pz, RVecD& m) {
    // Custom logic to modify px[pos], py[pos]... based on indices
}

// 2. Register in Analysis Script
kine.Creator().AddParticle("MyPart", MyDecayCreator, {{"Mother"}, {"Daughter"}});
        </div>
    </div>

    <div class="rad-card p-6 border-l-4 border-pink-500">
        <h3 class="text-xl font-bold text-white mb-2"><span class="role-badge role-modifier">Modifier</span> ParticleModifier</h3>
        <p class="text-slate-300 mb-4">
            <strong>Role:</strong> The "Mechanic". Applies in-place corrections to the 4-vectors <em>inside the event loop</em>. Used for Calibration, Smearing, or Constraints. It can request auxiliary data (like Calorimeter Energy) to use in the correction.
        </p>
        <h4 class="font-bold text-pink-400 mb-2">How to Extend (New Correction):</h4>
        <p class="text-sm text-slate-400 mb-2">Inherit from <code>ModifierBase</code>.</p>
        <div class="code-block">
// 1. Define Custom Strategy
class MyEnergyScale : public rad::ModifierBase {
public:
    MyEnergyScale(double factor) : _factor(factor) {}
    
    // Required: Clone pattern
    std::unique_ptr<ModifierBase> Clone() const override { 
        return std::make_unique<MyEnergyScale>(_factor); 
    }

    // The Logic: Modifies px, py, pz in-place
    void operator()(RVecD& px, RVecD& py, RVecD& pz, RVecD& m, 
                    const AuxCacheD&, const AuxCacheI&) const override {
        // _target_idx is set automatically by framework
        px[_target_idx] *= _factor; 
        py[_target_idx] *= _factor;
        pz[_target_idx] *= _factor;
    }
private:
    double _factor;
};

// 2. Register in Analysis Script ("ele" is the particle to modify)
kine.PreModifier().AddCustom<MyEnergyScale>("ele", {}, {}, 1.05); 
        </div>
    </div>
  </section>

  <section>
    <h2 class="section-title">6. Writing Custom Physics Kernels</h2>
    <p class="mb-4">
        To add new physics (e.g., a specific angle calculation), create a C++ function and register it via <code>KineCalculation</code>.
    </p>

    <div class="rad-card p-6">
        <h3 class="text-lg font-bold text-white mb-2">The Function Signature</h3>
        <p class="text-sm text-slate-400 mb-4">
            The function must accept the <code>RVecIndexMap</code> (topology) and the flat data arrays.
        </p>
        <div class="code-block">
// MyPhysics.h
namespace rad {
  namespace physics {

    // Calculate "Time" (t) transfer
    inline RVecResultType CalcT(const RVecIndexMap& map, 
                                const RVecResultType& px, 
                                const RVecResultType& py, 
                                const RVecResultType& pz, 
                                const RVecResultType& m) 
    {
      // 1. Get Indices
      // rad::consts::OrderBeamEle() returns the fixed row index for the beam.
      auto idx_beam = map[rad::consts::OrderBeamEle()]; 
      auto idx_scat = map[rad::consts::OrderScatEle()];

      // 2. Perform Vectorized Calculation
      auto px_q = px[idx_beam] - px[idx_scat];
      // ... math ...
      return t_values; 
    }
  }
}
        </div>
    </div>
  </section>

</body>
</html>
